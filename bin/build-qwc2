#!/bin/sh
{
    echo ''
    startdir=`pwd`
    buildmain=
        "yarn install \
      && cp -rf /qwc2conf/* ./ \
      && yarn run prod \
      && echo 'Please wait, copying files to /qwc2...' \
      && rsync --recursive --copy-links --size-only --delete /usr/local/src/qwc2-demo-app/prod/ /qwc2 \
      && rsync --recursive --copy-links --ignore-existing --size-only --exclude '*/' --include 'qwc2/' /usr/local/src/qwc2-demo-app/* /qwc2 \
      && echo 'QWC2 build successfull!' \
      || echo 'QWC2 build FAILED'"
    build="cd /usr/local/src/qwc2-demo-app && $buildmain"
    buildstart="$build || /usr/local/bin/clone-qwc2 && $build || echo 'QWC2 clone FAILED'"
    if [ "`id -u`" -eq 0 ]
    then
        chpst -u ${USER} /bin/sh -c "HOME=/home/user && $buildstart"
    else
        $buildstart
    fi
    rm -rf /usr/local/src/qwc2-demo-app
    cd $startdir
} 2>&1 | tee -a /var/log/stdout+stderr.log &
exit
