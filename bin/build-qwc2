#!/bin/sh
{
    echo ''
    startdir=`pwd`
    and=' && '
    or=' || '
    A='cd /usr/local/src/qwc2-demo-app'
    B='yarn install'
    C='cp -rf /qwc2conf/* ./'
    D='yarn upgrade'
    E='yarn run tsupdate'
    F='yarn run prod'
    G='echo "Please wait, copying files to /qwc2..."'
    H='rsync --recursive --copy-links --size-only --delete /usr/local/src/qwc2-demo-app/prod/ /qwc2'
    I='rsync --recursive --copy-links --ignore-existing --size-only --include "qwc2/" --exclude "*/" /usr/local/src/qwc2-demo-app/* /qwc2'
    J='echo "QWC2 build successfull!"'
    BUILD=$A$and$B$and$C$and$D$and$E$and$F$and$G$and$H$and$I$and$J
    CLONE='/usr/local/bin/clone-qwc2'
    FAIL='echo "QWC2 build FAILED"'
    BUILD=$BUILD$or$CLONE$and$BUILD$or$FAIL
    if [ "`id -u`" -eq 0 ]
    then
        SETHOME='HOME=/home/user'
        BUILD=$SETHOME$and$BUILD
        chpst -u ${USER} /bin/sh -c "$BUILD"
    else
        $BUILD
    fi
    rm -rf /usr/local/src/qwc2-demo-app
    cd $startdir
} 2>&1 | tee -a /var/log/stdout+stderr.log &
exit
