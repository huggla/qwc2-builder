#!/bin/sh
{
    echo ''
    startdir=`pwd`
    a='yarn install '
    b='&& cp -rf /qwc2conf/* ./ '
    b2='&& yarn upgrade '
    b3='&& yarn run tsupdate '
    c='&& yarn run prod '
    d='&& echo "Please wait, copying files to /qwc2..." '
    e='&& rsync --recursive --copy-links --size-only --delete /usr/local/src/qwc2-demo-app/prod/ /qwc2 '
    f='&& rsync --recursive --copy-links --ignore-existing --size-only --exclude "*/" --include "qwc2/" /usr/local/src/qwc2-demo-app/* /qwc2 '
    g='&& echo "QWC2 build successfull!" '
    buildmain=$a$b$b2$b3$c$d$e$f$g
    i='cd /usr/local/src/qwc2-demo-app && '
    build=$i$buildmain
    j='|| /usr/local/bin/clone-qwc2 && '
    k=' || echo "QWC2 build FAILED"'
    buildstart=$build$j$build$k
    if [ "`id -u`" -eq 0 ]
    then
        l='HOME=/home/user && '
        buildstart=$l$buildstart
        chpst -u ${USER} /bin/sh -c "$buildstart"
    else
        $buildstart
    fi
    rm -rf /usr/local/src/qwc2-demo-app
    cd $startdir
} 2>&1 | tee -a /var/log/stdout+stderr.log &
exit
